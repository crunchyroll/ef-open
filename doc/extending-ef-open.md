## Extending CRF-Open

The crf-open toolset has the ability to be extended through the use of plugins in the form of python packages. 
All installed plugins that are designated for the tool being used (ex. crf-cf) will be executed on --commit.

## Installing a plugin
The plugins directory should be at the root of your infrastructure repo and should contain an empty \_\_init\_\_.py file
along with any plugins that you wish to install. This can be either the plugin source or a symlink to the source. 
Currently the plugins directory must be named 'plugins', though it is possible that this will be configurable in 
crf_site_config.py in a later release. Any plugins in this directory are added to the compiled ef binaries generated by pants.

#####Sample Infrastructure Repository:

```
infra-repo/
  BUILD.crf_site_config
  BUILD.plugins
  crf_site_config.py
  plugins/
    __init__.py
    newrelic/
      __init__.py
      plugin_code.py
      config.py
      requirements.txt
```

## Viewing installed plugins
Executing a tool with the --verbose flag will list the installed plugins. 
As long as --commit was not also included the plugins will not be executed

## Creating a plugin
Plugins in crf-open are python packages containing one or more classes decorated with @crf_plugin

### Requirements
* must be formatted as a python package
* package module(s) contains at least one class decorated with @crf_plugin
* crf_plugin requires a string param indicating the crf-open tool being extended <br>_ex. @crf_plugin('crf-generate)_
* any modules making use of the crf_plugin decorator will need to _import crf_plugin_
* all plugin classes need to contain a run() method. This will be the functional executor of a plugin, 
similar to the main() function in standalone python scripts

### Development Notes
* plugin classes will have access to the CRFContext instance via _self.context_
* plugin classes will have access to the boto3 client dict created by crf_utils.create_aws_clients() via _self.clients_
* the above two attributes are not available during the plugin class init. This can be changed in a later release if needed.
* plugins can import other crf-open code. This can use useful for modules with helper functions such as crf_utils.py

####sample_plugin.py
```
from crf_plugin import crf_plugin
 
@crf_plugin('crf-generate')
class SamplePlugin(object):
 
   def run(self):
       env = self.context.env
       ec2 = self.clients['ec2']
       do_things(ec2, env)
```

#####Sample CRFContext object:
```
context_obj = {CRFContext} <crf_context.CRFContext object at 0x1042eb7d0>
 account_alias = {str} 'account-alias'
 account_id = {str} '123456789'
 commit = {bool} False
 devel = {bool} True
 env = {str} 'alpha0'
 env_full = {str} 'alpha0'
 env_short = {str} 'alpha'
 policy_template_path = {str} '/Users/dlutsch/workspace/crf-open/policy_templates/'
 service = {tuple} <type 'tuple'>: (u'cloudfront-static', {u'team_email': u'ops@example.com', u'type': u'aws_fixture', u'description': u'cloudfront dist for static content')
 service_registry = {CRFServiceRegistry} <crf_service_registry.CRFServiceRegistry object at 0x1042eb810>
 verbose = {bool} False
 whereami = {str} 'local'
```

#####Sample boto3 clients dict:
```
{
'SESSION': Session(region_name='us-west-2'),
'iam': <botocore.client.IAM object at 0x110d1c850>, 
'kms': <botocore.client.KMS object at 0x110e510d0>,
'ec2': <botocore.client.EC2 object at 0x110956150>
}
```

## Pants setup
The infrastructure repo will need to contain a BUILD.plugins file which contains the needed python library and requirements library. 
The python_requirement_library in this file needs to contain all third party libraries needed for use by the installed plugins 
(to be installed by pip). Plugins should include a requirements.txt listing all needed modules as a matter of best practice.
